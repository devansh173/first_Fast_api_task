<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Database API Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .tab:hover {
            background: #5568d3;
        }

        .tab.active {
            background: #764ba2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        .user-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .user-info.show {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .connection-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connection-info {
            flex: 1;
        }

        .connection-actions {
            display: flex;
            gap: 10px;
        }

        .query-result {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-upload-area:hover {
            background: #f0f0f0;
        }

        .file-upload-area.dragover {
            background: #e7f3ff;
            border-color: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Multi-Database API Dashboard</h1>
            <p>Manage databases, execute queries, and upload files</p>
        </div>

        <!-- User Info -->
        <div id="userInfo" class="user-info">
            <strong>Logged in as:</strong> <span id="username"></span>
            <button onclick="logout()" style="float: right; padding: 5px 15px; font-size: 14px;">Logout</button>
        </div>

        <!-- Messages -->
        <div id="message" class="message"></div>

        <!-- Auth Section -->
        <div id="authSection" class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('login')">Login</button>
                <button class="tab" onclick="switchTab('register')">Register</button>
            </div>

            <div id="loginTab" class="tab-content active">
                <h2>Login</h2>
                <form id="loginForm" onsubmit="login(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit">Login</button>
                </form>
            </div>

            <div id="registerTab" class="tab-content">
                <h2>Register</h2>
                <form id="registerForm" onsubmit="register(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="registerUsername" required minlength="3">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" required minlength="6">
                    </div>
                    <button type="submit">Register</button>
                </form>
            </div>
        </div>

        <!-- Main Dashboard (hidden until login) -->
        <div id="dashboard" style="display: none;">
            <!-- Database Connections -->
            <div class="card">
                <h2>üìä Database Connections</h2>
                <button onclick="showAddConnectionForm()" style="margin-bottom: 15px;">+ Add Connection</button>
                
                <div id="addConnectionForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 15px;">
                    <h3>Add New Connection</h3>
                    <form id="connectionForm" onsubmit="addConnection(event)">
                        <div class="form-group">
                            <label>Connection Name</label>
                            <input type="text" id="connName" required>
                        </div>
                        <div class="form-group">
                            <label>Database Type</label>
                            <select id="connDbType" required>
                                <option value="postgres">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="oracle">Oracle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Host</label>
                            <input type="text" id="connHost" required>
                        </div>
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" id="connPort" required>
                        </div>
                        <div class="form-group">
                            <label>Database</label>
                            <input type="text" id="connDatabase" required>
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="connUsername" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="connPassword" required>
                        </div>
                        <div class="btn-group">
                            <button type="submit">Save Connection</button>
                            <button type="button" class="secondary" onclick="hideAddConnectionForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div id="connectionsList"></div>
            </div>

            <!-- Query Execution -->
            <div class="card">
                <h2>üîç Execute Query</h2>
                <form id="queryForm" onsubmit="executeQuery(event)">
                    <div class="form-group">
                        <label>Use Stored Connection</label>
                        <select id="queryConnectionId">
                            <option value="">-- Select Connection --</option>
                        </select>
                    </div>
                    <div id="manualConnection" style="display: none;">
                        <div class="form-group">
                            <label>Database Type</label>
                            <select id="queryDbType">
                                <option value="postgres">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="oracle">Oracle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Host</label>
                            <input type="text" id="queryHost">
                        </div>
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" id="queryPort">
                        </div>
                        <div class="form-group">
                            <label>Database</label>
                            <input type="text" id="queryDatabase">
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="queryUsername">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="queryPassword">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>SQL Query</label>
                        <textarea id="querySql" required placeholder="SELECT * FROM users LIMIT 10;"></textarea>
                    </div>
                    <button type="submit">Execute Query</button>
                </form>
                <div id="queryResult" class="query-result"></div>
            </div>

            <!-- File Upload -->
            <div class="card">
                <h2>üìÅ Upload File</h2>
                <div class="file-upload-area" id="uploadArea" 
                     ondrop="handleDrop(event)" 
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)"
                     onclick="document.getElementById('fileInput').click()">
                    <p>üì§ Drag and drop a file here or click to browse</p>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">Supports files up to 10GB</p>
                </div>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
                <div id="uploadStatus" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let token = localStorage.getItem('token');
        let username = localStorage.getItem('username');

        // Check if user is logged in
        if (token && username) {
            showDashboard(username);
        }

        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 5000);
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.tab').classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('registerTab').classList.add('active');
            }
        }

        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    localStorage.setItem('username', username);
                    showDashboard(username);
                    showMessage('Login successful!', 'success');
                } else {
                    showMessage(data.detail || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function register(event) {
            event.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('Registration successful! Please login.', 'success');
                    switchTab('login');
                    document.getElementById('loginUsername').value = username;
                } else {
                    showMessage(data.detail || 'Registration failed', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function logout() {
            token = null;
            username = null;
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('userInfo').classList.remove('show');
            showMessage('Logged out successfully', 'success');
        }

        function showDashboard(user) {
            username = user;
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('userInfo').classList.add('show');
            document.getElementById('username').textContent = user;
            loadConnections();
        }

        async function loadConnections() {
            try {
                const response = await fetch(`${API_BASE}/db-connections`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const connections = await response.json();
                    displayConnections(connections);
                    updateConnectionDropdown(connections);
                }
            } catch (error) {
                console.error('Error loading connections:', error);
            }
        }

        function displayConnections(connections) {
            const listEl = document.getElementById('connectionsList');
            if (connections.length === 0) {
                listEl.innerHTML = '<p>No connections configured. Add one to get started!</p>';
                return;
            }

            listEl.innerHTML = connections.map(conn => `
                <div class="connection-item">
                    <div class="connection-info">
                        <strong>${conn.name}</strong> - ${conn.db_type.toUpperCase()}<br>
                        <small>${conn.host}:${conn.port}/${conn.database} (${conn.username})</small>
                    </div>
                    <div class="connection-actions">
                        <button class="secondary" onclick="useConnection(${conn.id})">Use</button>
                        <button class="danger" onclick="deleteConnection(${conn.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updateConnectionDropdown(connections) {
            const select = document.getElementById('queryConnectionId');
            select.innerHTML = '<option value="">-- Select Connection --</option>' +
                connections.map(c => `<option value="${c.id}">${c.name} (${c.db_type})</option>`).join('');
            
            select.addEventListener('change', (e) => {
                document.getElementById('manualConnection').style.display = 
                    e.target.value ? 'none' : 'block';
            });
        }

        function showAddConnectionForm() {
            document.getElementById('addConnectionForm').style.display = 'block';
        }

        function hideAddConnectionForm() {
            document.getElementById('addConnectionForm').style.display = 'none';
            document.getElementById('connectionForm').reset();
        }

        async function addConnection(event) {
            event.preventDefault();
            const connection = {
                name: document.getElementById('connName').value,
                db_type: document.getElementById('connDbType').value,
                host: document.getElementById('connHost').value,
                port: parseInt(document.getElementById('connPort').value),
                database: document.getElementById('connDatabase').value,
                username: document.getElementById('connUsername').value,
                password: document.getElementById('connPassword').value
            };

            try {
                const response = await fetch(`${API_BASE}/db-connections`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(connection)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('Connection added successfully!', 'success');
                    hideAddConnectionForm();
                    loadConnections();
                } else {
                    showMessage(data.detail || 'Failed to add connection', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function deleteConnection(id) {
            if (!confirm('Are you sure you want to delete this connection?')) return;

            try {
                const response = await fetch(`${API_BASE}/db-connections/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showMessage('Connection deleted successfully!', 'success');
                    loadConnections();
                } else {
                    showMessage('Failed to delete connection', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function useConnection(id) {
            document.getElementById('queryConnectionId').value = id;
            document.getElementById('manualConnection').style.display = 'none';
        }

        async function executeQuery(event) {
            event.preventDefault();
            const resultEl = document.getElementById('queryResult');
            resultEl.innerHTML = '<p>Executing query...</p>';

            const connectionId = document.getElementById('queryConnectionId').value;
            const query = document.getElementById('querySql').value;

            let requestBody = { query };

            if (connectionId) {
                requestBody.connection_id = parseInt(connectionId);
            } else {
                requestBody.db_type = document.getElementById('queryDbType').value;
                requestBody.host = document.getElementById('queryHost').value;
                requestBody.port = parseInt(document.getElementById('queryPort').value);
                requestBody.database = document.getElementById('queryDatabase').value;
                requestBody.username = document.getElementById('queryUsername').value;
                requestBody.password = document.getElementById('queryPassword').value;
            }

            try {
                const response = await fetch(`${API_BASE}/db/query`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                if (response.ok) {
                    if (data.data) {
                        // Display results in table
                        let html = '<h3>Query Results:</h3><table><thead><tr>';
                        if (data.data.length > 0) {
                            Object.keys(data.data[0]).forEach(key => {
                                html += `<th>${key}</th>`;
                            });
                            html += '</tr></thead><tbody>';
                            data.data.forEach(row => {
                                html += '<tr>';
                                Object.values(row).forEach(val => {
                                    html += `<td>${val !== null ? val : 'NULL'}</td>`;
                                });
                                html += '</tr>';
                            });
                            html += '</tbody></table>';
                        } else {
                            html += '<p>No rows returned.</p>';
                        }
                        resultEl.innerHTML = html;
                    } else {
                        resultEl.innerHTML = `<p>‚úÖ ${data.message}</p>`;
                    }
                } else {
                    resultEl.innerHTML = `<p style="color: red;">Error: ${data.detail}</p>`;
                }
            } catch (error) {
                resultEl.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadFile(file);
            }
        }

        async function uploadFile(file) {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.innerHTML = `<p>Uploading ${file.name}...</p>`;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/upload/bigfile`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    statusEl.innerHTML = `
                        <div class="message success show">
                            ‚úÖ File uploaded successfully!<br>
                            <strong>File:</strong> ${data.filename}<br>
                            <strong>Size:</strong> ${data.size_mb} MB<br>
                            <strong>Path:</strong> ${data.file_path}
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = `
                        <div class="message error show">
                            ‚ùå Upload failed: ${data.detail}
                        </div>
                    `;
                }
            } catch (error) {
                statusEl.innerHTML = `
                    <div class="message error show">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>

